<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agora Video Call - Simple Client</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.jsdelivr.net/npm/agora-rtc-sdk-ng@4.20.2"></script>
  <style>
    :root { --bg: #0f172a; --panel: #111827; --muted: #9ca3af; --accent:#06b6d4; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; background: var(--bg); color: #e5e7eb; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    h1 { margin: 0 0 16px; font-size: 22px; font-weight: 700; }
    .card { background: var(--panel); border: 1px solid #1f2937; border-radius: 14px; padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #374151; background: #0b1220; color: #e5e7eb; outline: none; }
    input#token { border: 2px solid #06b6d4; background: #0f172a; }
    input#token:focus { border-color: #0891b2; box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1); }
    input::placeholder { color: #6b7280; }
    .actions { display:flex; gap: 10px; margin-top: 12px; }
    button { padding: 10px 14px; border: 1px solid #1f2937; border-radius: 10px; background: #0b1220; color: #e5e7eb; cursor: pointer; }
    button.primary { background: linear-gradient(135deg, #0891b2, #06b6d4); border: none; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .videos { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    .video { background: #0b1220; border: 1px solid #1f2937; border-radius: 14px; min-height: 260px; position: relative; overflow: hidden; }
    .video h3 { position: absolute; top: 8px; left: 10px; margin: 0; font-size: 12px; color: var(--muted); }
    .note { font-size: 12px; color: var(--muted); margin-top: 8px; }
  </style>
  <!-- Tip: Generate token with `py app/utils/agora_tokens_standalone.py myroom --uid 0` and paste below. -->
</head>
<body>
  <div class="container">
    <h1>Agora Video Call - Test Client</h1>
    <div class="card">
      <div>
        <label>App ID (turadi)</label>
        <input id="appId" value="e406a7515b244f6b968ab0520532609a" readonly style="background: #1a1f2e; color: #9ca3af;" />
      </div>
      <div style="margin-top: 12px;">
        <label>Channel Name</label>
        <input id="channel" placeholder="7d72365eb983485397e3e3f9d460bdda" />
      </div>
      <div style="margin-top: 12px;">
        <label>Token (Required)</label>
        <input id="token" placeholder="007e.IxTYPj8cUqt5jTZ7cdITySkfX0k/bxpas28E7XfnqAlSOZM7dPgSHVxMAs0dzU0DTJ..." />
      </div>
      <div class="row" style="margin-top: 12px;">
        <div>
          <label>UID (0 = auto)</label>
          <input id="uid" type="number" value="17" />
        </div>
        <div>
          <label>Role (RTC Mode)</label>
          <select id="role">
            <option value="host" selected>Publisher (All users in RTC mode)</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top: 12px;">
        <div>
          <label>Audio</label>
          <select id="audio">
            <option value="on" selected>On</option>
            <option value="off">Off</option>
          </select>
        </div>
        <div>
          <label>Video</label>
          <select id="video">
            <option value="on" selected>On</option>
            <option value="off">Off</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button id="join" class="primary">Join</button>
        <button id="leave">Leave</button>
        <button id="toggle-audio">Mute Audio</button>
        <button id="toggle-video">Mute Video</button>
      </div>
      <div class="note">
        <strong>Instructions:</strong><br>
        1. <strong>Token qo'lda kiritsangiz:</strong> Channel va Token'ni kiriting, "Join" tugmasini bosing<br>
        2. <strong>Token bo'lmasa:</strong> Faqat Channel'ni kiriting (raqam - room_id), "Join" tugmasini bosing - backend token generate qiladi<br>
        3. Ikkala foydalanuvchi ham bir xil Channel nomidan foydalanishi kerak<br>
        4. <strong>Eslatma:</strong> Token qo'lda kiritilganda, Channel nomi ham to'g'ri bo'lishi kerak
      </div>
    </div>

    <div class="videos">
      <div class="video">
        <h3>Local</h3>
        <div id="local-player" style="width:100%; height:100%"></div>
      </div>
      <div class="video">
        <h3>Remote</h3>
        <div id="remote-player" style="width:100%; height:100%"></div>
      </div>
    </div>
  </div>

  <script>
    const client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
    let localAudioTrack = null;
    let localVideoTrack = null;
    let joined = false;
    let isJoining = false; // Flag to prevent multiple join attempts
    let autoJoinTimeout = null; // Global timeout for auto-join

    const q = (id) => document.getElementById(id);

    // Hard-coded defaults
    const DEFAULTS = {
      appId: 'e406a7515b244f6b968ab0520532609a',
      channel: '',
      token: '',
      uid: 17,
      role: 'host',
      audio: true,
      video: true,
    };

    function getInputs() {
      // Get all values from inputs
      return {
        appId: q('appId').value.trim() || DEFAULTS.appId,
        channel: q('channel').value.trim() || DEFAULTS.channel,
        token: q('token').value.trim() || DEFAULTS.token,
        uid: parseInt(q('uid').value) || DEFAULTS.uid,
        role: q('role').value || DEFAULTS.role,
        audio: q('audio').value === 'on',
        video: q('video').value === 'on'
      };
    }

    function ensureInputs({ appId, channel, token }) {
      if (!appId) throw new Error('App ID is required');
      if (!channel) throw new Error('Channel is required');
      if (!token) throw new Error('Token is required - Please enter your Agora token');
    }

    function onRemoteUserPublished(user, mediaType) {
      client.subscribe(user, mediaType).then(() => {
        if (mediaType === 'video') {
          const remotePlayer = q('remote-player');
          user.videoTrack && user.videoTrack.play(remotePlayer);
        }
        if (mediaType === 'audio') {
          user.audioTrack && user.audioTrack.play();
        }
      });
    }

    function onRemoteUserUnpublished(user, mediaType) {
      if (mediaType === 'video') {
        const remotePlayer = q('remote-player');
        remotePlayer.innerHTML = '';
      }
    }

    client.on('user-published', onRemoteUserPublished);
    client.on('user-unpublished', onRemoteUserUnpublished);

    function setUiState() {
      q('join').disabled = joined || client.connectionState !== 'DISCONNECTED';
      q('leave').disabled = !joined;
    }

    async function join(isAutoJoin = false) {
      // Prevent multiple join attempts
      if (isJoining) {
        if (!isAutoJoin) {
          console.log('Join already in progress, please wait...');
        }
        return;
      }
      
      if (joined) {
        if (!isAutoJoin) {
          alert('Already connected to channel. Please leave first.');
        }
        return;
      }
      
      if (client.connectionState === 'CONNECTING' || client.connectionState === 'CONNECTED' || client.connectionState === 'RECONNECTING') {
        if (!isAutoJoin) {
          alert('Already connecting/connected');
        }
        return;
      }
      
      isJoining = true; // Set flag to prevent multiple attempts
      
      const inputs = getInputs();
      if (!inputs.appId || !inputs.channel) {
        alert('App ID and Channel are required');
        return;
      }

      try {
        console.log('Initializing Agora client...');
        
        // Initialize client
        if (!client) {
          client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
        }
        
        let token = inputs.token;
        let channelName = inputs.channel;
        let uidToUse = inputs.uid || 0;
        
        // Agar token qo'lda kiritilgan bo'lsa, uni ishlatish
        // Lekin agar channel raqam bo'lsa (room_id), backend'dan yangi token olish yaxshiroq
        const channelIsRoomId = /^\d+$/.test(channelName.trim());
        
        if (token && token.trim() && !channelIsRoomId) {
          // Token bor va channel raqam emas - qo'lda kiritilgan token ishlatiladi
          console.log('Using manually entered token');
          console.log(`Token format: ${token.startsWith('006') ? '006 (Legacy)' : token.startsWith('007') ? '007 (Current)' : 'Unknown'}`);
          console.warn('⚠️ IMPORTANT: When using a manually entered token:');
          console.warn('  1. Channel name MUST match the channel used to generate the token');
          console.warn('  2. UID MUST match the UID used to generate the token (or be 0 if token was generated with 0)');
          console.warn('  3. App ID MUST match the App ID used to generate the token');
          console.warn(`  Current Channel: ${channelName}`);
          console.warn(`  Current UID: ${uidToUse}`);
          console.warn(`  Current App ID: ${inputs.appId}`);
        } else {
          // Token bo'lmasa yoki channel raqam bo'lsa (room_id), backend'dan yangi token olish
          if (channelIsRoomId) {
            console.log('Channel is a room ID, getting fresh token from backend...');
          } else {
            console.log('No token provided, getting fresh token from backend...');
          }
          const roomId = channelIsRoomId ? parseInt(inputs.channel) : (parseInt(inputs.channel) || 1);
          const tokenResponse = await fetch('/api/v1/chat/video-call/token/test', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              room_id: roomId,
              uid: inputs.uid || 0,
              user_account: null,
              role: 'publisher',
              expire_seconds: 3600
            })
          });
          
          if (!tokenResponse.ok) {
            throw new Error(`Backend error: ${tokenResponse.status} ${tokenResponse.statusText}`);
          }
          
          const tokenData = await tokenResponse.json();
          token = tokenData.token;
          channelName = tokenData.channel;
          uidToUse = tokenData.uid || inputs.uid || 0;
          
          console.log(`Got token from backend: ${token.substring(0, 50)}...`);
          console.log(`Token format: ${token.startsWith('006') ? '006 (Legacy)' : token.startsWith('007') ? '007 (Current)' : 'Unknown'}`);
          console.log(`Channel name from backend: ${channelName}`);
          console.log(`UID from backend: ${uidToUse}`);
          
          // Update fields with values from backend
          document.getElementById('token').value = token;
          document.getElementById('channel').value = channelName;
          document.getElementById('uid').value = uidToUse;
        }
        
        if (!token || !token.trim()) {
          throw new Error('Token is required - Please enter your Agora token or let backend generate it');
        }
        
        // Note: setClientRole is not available in RTC mode
        // In RTC mode, all users are publishers by default
        console.log(`Role: ${inputs.role} (RTC mode - all users are publishers)`);
        
        // Join channel
        console.log(`Joining channel: ${channelName} with token`);
        console.log(`Using App ID: ${inputs.appId}, Channel: ${channelName}, UID: ${uidToUse}`);
        console.log(`Token length: ${token.length}, starts with: ${token.substring(0, 3)}`);
        
        try {
          const uid = await client.join(inputs.appId, channelName, token, uidToUse);
          joined = true;
          console.log(`Successfully joined with UID: ${uid}`);
          
          // Create and publish tracks
          if (inputs.audio) {
            localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
            await client.publish([localAudioTrack]);
            console.log('Audio track published');
          }
          
          if (inputs.video) {
            localVideoTrack = await AgoraRTC.createCameraVideoTrack();
            await client.publish([localVideoTrack]);
            localVideoTrack.play('local-player');
            console.log('Video track published and playing');
          }
          
          // Set up event listeners
          client.on('user-published', async (user, mediaType) => {
            console.log(`Remote user ${user.uid} published ${mediaType}`);
            await client.subscribe(user, mediaType);
            
            if (mediaType === 'video') {
              user.videoTrack.play('remote-player');
              console.log('Remote video playing');
            }
            if (mediaType === 'audio') {
              user.audioTrack.play();
              console.log('Remote audio playing');
            }
          });
          
          client.on('user-unpublished', (user, mediaType) => {
            console.log(`Remote user ${user.uid} unpublished ${mediaType}`);
          });
          
          setUiState();
          console.log('Video call started successfully!');
        } catch (joinError) {
          // Specific error handling for join failures
          console.error('Failed to join channel:', joinError);
          let errorMessage = joinError.message || 'Unknown error';
          
          if (errorMessage.includes('invalid token') || errorMessage.includes('authorized failed')) {
            // Agar channel raqam bo'lsa (room_id), backend'dan yangi token olishga harakat qilish
            const channelIsRoomId = /^\d+$/.test(channelName.trim());
            
            if (channelIsRoomId && token && token.trim()) {
              console.log('Token invalid, but channel is a room ID. Trying to get fresh token from backend...');
              try {
                const roomId = parseInt(channelName);
                const tokenResponse = await fetch('/api/v1/chat/video-call/token/test', {
                  method: 'POST',
                  headers: { 
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    room_id: roomId,
                    uid: uidToUse || 0,
                    user_account: null,
                    role: 'publisher',
                    expire_seconds: 3600
                  })
                });
                
                if (tokenResponse.ok) {
                  const tokenData = await tokenResponse.json();
                  console.log('Got fresh token from backend, retrying join...');
                  
                  // Update fields
                  document.getElementById('token').value = tokenData.token;
                  document.getElementById('channel').value = tokenData.channel;
                  document.getElementById('uid').value = tokenData.uid || uidToUse || 0;
                  
                  // Retry join with new token
                  token = tokenData.token;
                  channelName = tokenData.channel;
                  uidToUse = tokenData.uid || uidToUse || 0;
                  
                  const uid = await client.join(inputs.appId, channelName, token, uidToUse);
                  joined = true;
                  console.log(`Successfully joined with UID: ${uid} after token refresh`);
                  
                  // Continue with track creation (code below will execute)
                  if (inputs.audio) {
                    localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                    await client.publish([localAudioTrack]);
                    console.log('Audio track published');
                  }
                  
                  if (inputs.video) {
                    localVideoTrack = await AgoraRTC.createCameraVideoTrack();
                    await client.publish([localVideoTrack]);
                    localVideoTrack.play('local-player');
                    console.log('Video track published and playing');
                  }
                  
                  client.on('user-published', async (user, mediaType) => {
                    console.log(`Remote user ${user.uid} published ${mediaType}`);
                    await client.subscribe(user, mediaType);
                    
                    if (mediaType === 'video') {
                      user.videoTrack.play('remote-player');
                      console.log('Remote video playing');
                    }
                    if (mediaType === 'audio') {
                      user.audioTrack.play();
                      console.log('Remote audio playing');
                    }
                  });
                  
                  client.on('user-unpublished', (user, mediaType) => {
                    console.log(`Remote user ${user.uid} unpublished ${mediaType}`);
                  });
                  
                  setUiState();
                  console.log('Video call started successfully after token refresh!');
                  return; // Success, exit error handler
                }
              } catch (retryError) {
                console.error('Failed to get fresh token:', retryError);
              }
            }
            
            errorMessage = `Invalid token error:\n\n` +
              `This usually means:\n` +
              `1. Token doesn't match the Channel name (current: "${channelName}")\n` +
              `2. Token doesn't match the UID (current: ${uidToUse})\n` +
              `3. Token has expired\n` +
              `4. Token was generated with wrong App ID or Certificate\n\n` +
              `Solution: Clear the token field and let backend generate a new one, or ensure Channel and UID match the token.`;
          }
          
          throw new Error(errorMessage);
        }
        
      } catch (error) {
        console.error(`Error: ${error.message}`);
        if (!isAutoJoin) {
          alert(`Error: ${error.message}`);
        }
      } finally {
        isJoining = false; // Reset flag after join attempt completes
      }
    }

    async function leave() {
      if (!joined) return;
      
      // Clear auto-join timeout if exists
      if (autoJoinTimeout) {
        clearTimeout(autoJoinTimeout);
        autoJoinTimeout = null;
      }
      
      // Reset joining flag
      isJoining = false;
      
      if (localAudioTrack) { localAudioTrack.stop(); localAudioTrack.close(); localAudioTrack = null; }
      if (localVideoTrack) { localVideoTrack.stop(); localVideoTrack.close(); localVideoTrack = null; }
      await client.leave();
      q('local-player').innerHTML = '';
      q('remote-player').innerHTML = '';
      joined = false;
      setUiState();
    }

    async function toggleAudio() {
      if (!localAudioTrack) return;
      if (localAudioTrack.isPlaying) {
        await localAudioTrack.setEnabled(false);
        localAudioTrack.isPlaying = false;
        this.innerText = 'Unmute Audio';
      } else {
        await localAudioTrack.setEnabled(true);
        localAudioTrack.isPlaying = true;
        this.innerText = 'Mute Audio';
      }
    }

    async function toggleVideo() {
      if (!localVideoTrack) return;
      const enabled = localVideoTrack.enabled !== false;
      await localVideoTrack.setEnabled(!enabled);
      this.innerText = enabled ? 'Unmute Video' : 'Mute Video';
    }

    q('join').addEventListener('click', () => join().catch(err => alert(err.message || err)));
    q('leave').addEventListener('click', () => leave().catch(console.error));
    q('toggle-audio').addEventListener('click', function() { toggleAudio.call(this); });
    q('toggle-video').addEventListener('click', function() { toggleVideo.call(this); });

    // Initialize UI
    window.addEventListener('DOMContentLoaded', () => {
      // App ID is readonly, already set in HTML
      q('uid').value = DEFAULTS.uid;
      q('role').value = DEFAULTS.role === 'host' ? 'host' : 'audience';
      q('audio').value = DEFAULTS.audio ? 'on' : 'off';
      q('video').value = DEFAULTS.video ? 'on' : 'off';

      // Focus on channel input
      q('channel').focus();

      setUiState();
    });
  </script>
</body>
</html>


