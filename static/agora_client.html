<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agora Video Call - Simple Client</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.jsdelivr.net/npm/agora-rtc-sdk-ng@4.20.2"></script>
  <style>
    :root { --bg: #0f172a; --panel: #111827; --muted: #9ca3af; --accent:#06b6d4; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; background: var(--bg); color: #e5e7eb; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    h1 { margin: 0 0 16px; font-size: 22px; font-weight: 700; }
    .card { background: var(--panel); border: 1px solid #1f2937; border-radius: 14px; padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #374151; background: #0b1220; color: #e5e7eb; outline: none; }
    input::placeholder { color: #6b7280; }
    .actions { display:flex; gap: 10px; margin-top: 12px; }
    button { padding: 10px 14px; border: 1px solid #1f2937; border-radius: 10px; background: #0b1220; color: #e5e7eb; cursor: pointer; }
    button.primary { background: linear-gradient(135deg, #0891b2, #06b6d4); border: none; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .videos { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    .video { background: #0b1220; border: 1px solid #1f2937; border-radius: 14px; min-height: 260px; position: relative; overflow: hidden; }
    .video h3 { position: absolute; top: 8px; left: 10px; margin: 0; font-size: 12px; color: var(--muted); }
    .note { font-size: 12px; color: var(--muted); margin-top: 8px; }
  </style>
  <!-- Tip: Generate token with `py agora_tokens_standalone.py myroom --uid 0` and paste below. -->
</head>
<body>
  <div class="container">
    <h1>Agora Video Call - Simple Client</h1>
    <div class="card">
      <div class="row">
        <div>
          <label>App ID</label>
          <input id="appId" placeholder="7073e4de58144a0183aabdf87ad14d44" />
        </div>
        <div>
          <label>Channel</label>
          <input id="channel" placeholder="demo" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Token</label>
          <input id="token" placeholder="Paste token here" />
        </div>
        <div>
          <label>UID (0 = auto)</label>
          <input id="uid" type="number" placeholder="0" />
        </div>
      </div>
      <div class="row-3">
        <div>
          <label>Role</label>
          <select id="role">
            <option value="host" selected>publisher (host)</option>
            <option value="audience">subscriber (audience)</option>
          </select>
        </div>
        <div>
          <label>Audio</label>
          <select id="audio">
            <option value="on" selected>On</option>
            <option value="off">Off</option>
          </select>
        </div>
        <div>
          <label>Video</label>
          <select id="video">
            <option value="on" selected>On</option>
            <option value="off">Off</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button id="join" class="primary">Join</button>
        <button id="leave">Leave</button>
        <button id="toggle-audio">Mute Audio</button>
        <button id="toggle-video">Mute Video</button>
      </div>
      <div class="note">Generate a token in your terminal, then paste it here. Both ends must use the same Channel. If one side uses UID 0 (auto), the other can pick any number.</div>
    </div>

    <div class="videos">
      <div class="video">
        <h3>Local</h3>
        <div id="local-player" style="width:100%; height:100%"></div>
      </div>
      <div class="video">
        <h3>Remote</h3>
        <div id="remote-player" style="width:100%; height:100%"></div>
      </div>
    </div>
  </div>

  <script>
    const client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
    let localAudioTrack = null;
    let localVideoTrack = null;
    let joined = false;

    const q = (id) => document.getElementById(id);

    // Hard-coded defaults (edit here)
    const DEFAULTS = {
      appId: '7073e4de58144a0183aabdf87ad14d44',
      channel: 'demo',
      // NOTE: Token expires; regenerate and update here when needed
      token: '',
      uid: 0,
      role: 'host', // 'host' or 'audience'
      audio: true,
      video: true,
    };

    function getInputs() {
      // Use hard-coded values except token which can be typed in the input
      const tokenFromInput = (q('token').value || '').trim();
      return { ...DEFAULTS, token: tokenFromInput || DEFAULTS.token };
    }

    function ensureInputs({ appId, channel, token }) {
      if (!appId) throw new Error('App ID is required');
      if (!channel) throw new Error('Channel is required');
      if (!token) throw new Error('Token is required');
    }

    function onRemoteUserPublished(user, mediaType) {
      client.subscribe(user, mediaType).then(() => {
        if (mediaType === 'video') {
          const remotePlayer = q('remote-player');
          user.videoTrack && user.videoTrack.play(remotePlayer);
        }
        if (mediaType === 'audio') {
          user.audioTrack && user.audioTrack.play();
        }
      });
    }

    function onRemoteUserUnpublished(user, mediaType) {
      if (mediaType === 'video') {
        const remotePlayer = q('remote-player');
        remotePlayer.innerHTML = '';
      }
    }

    client.on('user-published', onRemoteUserPublished);
    client.on('user-unpublished', onRemoteUserUnpublished);

    function setUiState() {
      q('join').disabled = joined || client.connectionState !== 'DISCONNECTED';
      q('leave').disabled = !joined;
    }

    async function join() {
      if (joined) return;
      if (client.connectionState === 'CONNECTING' || client.connectionState === 'CONNECTED' || client.connectionState === 'RECONNECTING') {
        alert('Already connecting/connected');
        return;
      }
      const { appId, channel, token, uid, role, audio, video } = getInputs();
      ensureInputs({ appId, channel, token });

      if (role === 'audience') {
        client.setClientRole('audience');
      } else {
        client.setClientRole('host');
      }

      setUiState();
      // Important: if uid is 0, pass 0 (do NOT coerce to null)
      const joinUid = (uid === 0 ? 0 : (uid ?? null));
      const actualUid = await client.join(appId, channel, token, joinUid);
      joined = true;
      setUiState();

      if (audio) {
        localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
      }
      if (video) {
        localVideoTrack = await AgoraRTC.createCameraVideoTrack();
      }

      if (localVideoTrack) {
        localVideoTrack.play('local-player');
      }

      const tracks = [];
      if (localAudioTrack) tracks.push(localAudioTrack);
      if (localVideoTrack) tracks.push(localVideoTrack);
      if (tracks.length) await client.publish(tracks);
    }

    async function leave() {
      if (!joined) return;
      if (localAudioTrack) { localAudioTrack.stop(); localAudioTrack.close(); localAudioTrack = null; }
      if (localVideoTrack) { localVideoTrack.stop(); localVideoTrack.close(); localVideoTrack = null; }
      await client.leave();
      q('local-player').innerHTML = '';
      q('remote-player').innerHTML = '';
      joined = false;
      setUiState();
    }

    async function toggleAudio() {
      if (!localAudioTrack) return;
      if (localAudioTrack.isPlaying) {
        await localAudioTrack.setEnabled(false);
        localAudioTrack.isPlaying = false;
        this.innerText = 'Unmute Audio';
      } else {
        await localAudioTrack.setEnabled(true);
        localAudioTrack.isPlaying = true;
        this.innerText = 'Mute Audio';
      }
    }

    async function toggleVideo() {
      if (!localVideoTrack) return;
      const enabled = localVideoTrack.enabled !== false;
      await localVideoTrack.setEnabled(!enabled);
      this.innerText = enabled ? 'Unmute Video' : 'Mute Video';
    }

    q('join').addEventListener('click', () => join().catch(err => alert(err.message || err)));
    q('leave').addEventListener('click', () => leave().catch(console.error));
    q('toggle-audio').addEventListener('click', function() { toggleAudio.call(this); });
    q('toggle-video').addEventListener('click', function() { toggleVideo.call(this); });

    // Initialize UI with hard-coded defaults and lock inputs
    window.addEventListener('DOMContentLoaded', () => {
      q('appId').value = DEFAULTS.appId;
      q('channel').value = DEFAULTS.channel;
      q('token').value = DEFAULTS.token;
      q('uid').value = DEFAULTS.uid;
      q('role').value = DEFAULTS.role === 'host' ? 'host' : 'audience';
      q('audio').value = DEFAULTS.audio ? 'on' : 'off';
      q('video').value = DEFAULTS.video ? 'on' : 'off';

      // Disable editing to enforce hard-coded inputs
      q('appId').disabled = true;
      q('channel').disabled = true;
      // Keep token input editable so you can paste a new token
      // q('token').disabled = true;
      q('uid').disabled = true;
      q('role').disabled = true;
      q('audio').disabled = true;
      q('video').disabled = true;

      setUiState();
    });
  </script>
</body>
</html>


