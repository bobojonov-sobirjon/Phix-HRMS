<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agora Video Call - Simple Client</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.jsdelivr.net/npm/agora-rtc-sdk-ng@4.20.2"></script>
  <style>
    :root { --bg: #0f172a; --panel: #111827; --muted: #9ca3af; --accent:#06b6d4; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; background: var(--bg); color: #e5e7eb; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    h1 { margin: 0 0 16px; font-size: 22px; font-weight: 700; }
    .card { background: var(--panel); border: 1px solid #1f2937; border-radius: 14px; padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #374151; background: #0b1220; color: #e5e7eb; outline: none; }
    input#token { border: 2px solid #06b6d4; background: #0f172a; }
    input#token:focus { border-color: #0891b2; box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1); }
    input::placeholder { color: #6b7280; }
    .actions { display:flex; gap: 10px; margin-top: 12px; }
    button { padding: 10px 14px; border: 1px solid #1f2937; border-radius: 10px; background: #0b1220; color: #e5e7eb; cursor: pointer; }
    button.primary { background: linear-gradient(135deg, #0891b2, #06b6d4); border: none; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .videos { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    .video { background: #0b1220; border: 1px solid #1f2937; border-radius: 14px; min-height: 260px; position: relative; overflow: hidden; }
    .video h3 { position: absolute; top: 8px; left: 10px; margin: 0; font-size: 12px; color: var(--muted); }
    .note { font-size: 12px; color: var(--muted); margin-top: 8px; }
  </style>
  <!-- Tip: Generate token with `py app/utils/agora_tokens_standalone.py myroom --uid 0` and paste below. -->
</head>
<body>
  <div class="container">
    <h1>Agora Video Call - Simple Client</h1>
    <div class="card">
      <div class="row">
        <div>
          <label>App ID</label>
          <input id="appId" placeholder="e406a7515b244f6b968ab0520532609a" />
        </div>
        <div>
          <label>Channel</label>
          <input id="channel" placeholder="2" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Token (Required)</label>
          <input id="token" placeholder="Paste your Agora token here" />
        </div>
        <div>
          <label>UID (0 = auto)</label>
          <input id="uid" type="number" placeholder="0" />
        </div>
      </div>
      <div class="row-3">
        <div>
          <label>Role (RTC Mode)</label>
          <select id="role">
            <option value="host" selected>Publisher (All users in RTC mode)</option>
          </select>
        </div>
        <div>
          <label>Audio</label>
          <select id="audio">
            <option value="on" selected>On</option>
            <option value="off">Off</option>
          </select>
        </div>
        <div>
          <label>Video</label>
          <select id="video">
            <option value="on" selected>On</option>
            <option value="off">Off</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button id="join" class="primary">Join</button>
        <button id="leave">Leave</button>
        <button id="toggle-audio">Mute Audio</button>
        <button id="toggle-video">Mute Video</button>
      </div>
         <div class="note">
           <strong>Instructions:</strong><br>
           1. Fresh token will be automatically generated from backend (007 format)<br>
           2. Enter Room ID in Channel field (e.g., 9 for room_id 9)<br>
           3. Both users must use the same Room ID<br>
           4. Click "Join" to start video call<br>
           5. No manual token entry needed - backend handles everything<br>
           6. <strong>Note:</strong> You need to be authenticated (login first) to generate tokens
         </div>
    </div>

    <div class="videos">
      <div class="video">
        <h3>Local</h3>
        <div id="local-player" style="width:100%; height:100%"></div>
      </div>
      <div class="video">
        <h3>Remote</h3>
        <div id="remote-player" style="width:100%; height:100%"></div>
      </div>
    </div>
  </div>

  <script>
    const client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
    let localAudioTrack = null;
    let localVideoTrack = null;
    let joined = false;

    const q = (id) => document.getElementById(id);

    // Hard-coded defaults (edit here)
    const DEFAULTS = {
      appId: 'e406a7515b244f6b968ab0520532609a',
      channel: '2',
      // NOTE: Token must be entered by user - no hardcoded token
      token: '',
      uid: 0,
      role: 'host', // 'host' or 'audience'
      audio: true,
      video: true,
    };

    function getInputs() {
      // Get all values from inputs
      return {
        appId: q('appId').value.trim() || DEFAULTS.appId,
        channel: q('channel').value.trim() || DEFAULTS.channel,
        token: q('token').value.trim() || DEFAULTS.token,
        uid: parseInt(q('uid').value) || DEFAULTS.uid,
        role: q('role').value || DEFAULTS.role,
        audio: q('audio').value === 'on',
        video: q('video').value === 'on'
      };
    }

    function ensureInputs({ appId, channel, token }) {
      if (!appId) throw new Error('App ID is required');
      if (!channel) throw new Error('Channel is required');
      if (!token) throw new Error('Token is required - Please enter your Agora token');
    }

    function onRemoteUserPublished(user, mediaType) {
      client.subscribe(user, mediaType).then(() => {
        if (mediaType === 'video') {
          const remotePlayer = q('remote-player');
          user.videoTrack && user.videoTrack.play(remotePlayer);
        }
        if (mediaType === 'audio') {
          user.audioTrack && user.audioTrack.play();
        }
      });
    }

    function onRemoteUserUnpublished(user, mediaType) {
      if (mediaType === 'video') {
        const remotePlayer = q('remote-player');
        remotePlayer.innerHTML = '';
      }
    }

    client.on('user-published', onRemoteUserPublished);
    client.on('user-unpublished', onRemoteUserUnpublished);

    function setUiState() {
      q('join').disabled = joined || client.connectionState !== 'DISCONNECTED';
      q('leave').disabled = !joined;
    }

    async function join() {
      if (joined) return;
      if (client.connectionState === 'CONNECTING' || client.connectionState === 'CONNECTED' || client.connectionState === 'RECONNECTING') {
        alert('Already connecting/connected');
        return;
      }
      
      const inputs = getInputs();
      if (!inputs.appId || !inputs.channel) {
        alert('App ID and Channel are required');
        return;
      }

      try {
        console.log('Initializing Agora client...');
        
        // Initialize client
        if (!client) {
          client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
        }
        
        // Get fresh token from backend (using test endpoint - no auth required)
        console.log('Getting fresh token from backend...');
        // Note: channel input is used as room_id for testing
        const roomId = parseInt(inputs.channel) || 1; // Use channel input as room_id
        const tokenResponse = await fetch('/api/v1/chat/video-call/token/test', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            room_id: roomId,
            uid: inputs.uid || 0, // 0 for auto-assign
            user_account: null,
            role: 'publisher',
            expire_seconds: 3600
          })
        });
        
        if (!tokenResponse.ok) {
          throw new Error(`Backend error: ${tokenResponse.status} ${tokenResponse.statusText}`);
        }
        
        const tokenData = await tokenResponse.json();
        const token = tokenData.token;
        const channelName = tokenData.channel; // Get channel name from response
        const uidFromResponse = tokenData.uid; // Get UID from response (may be 0 or auto-assigned)
        
        console.log(`Got token from backend: ${token.substring(0, 50)}...`);
        console.log(`Token format: ${token.startsWith('006') ? '006 (Legacy)' : token.startsWith('007') ? '007 (Current)' : 'Unknown'}`);
        console.log(`Channel name from backend: ${channelName}`);
        console.log(`UID from backend: ${uidFromResponse}`);
        
        // Update token field and channel field with values from backend
        document.getElementById('token').value = token;
        document.getElementById('channel').value = channelName;
        document.getElementById('uid').value = uidFromResponse || 0;
        
        // Note: setClientRole is not available in RTC mode
        // In RTC mode, all users are publishers by default
        console.log(`Role: ${inputs.role} (RTC mode - all users are publishers)`);
        
        // Join channel using channel name from backend response
        console.log(`Joining channel: ${channelName}`);
        const uid = await client.join(inputs.appId, channelName, token, uidFromResponse || inputs.uid);
        joined = true;
        console.log(`Successfully joined with UID: ${uid}`);
        
        // Create and publish tracks
        if (inputs.audio) {
          localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
          await client.publish([localAudioTrack]);
          console.log('Audio track published');
        }
        
        if (inputs.video) {
          localVideoTrack = await AgoraRTC.createCameraVideoTrack();
          await client.publish([localVideoTrack]);
          localVideoTrack.play('local-player');
          console.log('Video track published and playing');
        }
        
        // Set up event listeners
        client.on('user-published', async (user, mediaType) => {
          console.log(`Remote user ${user.uid} published ${mediaType}`);
          await client.subscribe(user, mediaType);
          
          if (mediaType === 'video') {
            user.videoTrack.play('remote-player');
            console.log('Remote video playing');
          }
          if (mediaType === 'audio') {
            user.audioTrack.play();
            console.log('Remote audio playing');
          }
        });
        
        client.on('user-unpublished', (user, mediaType) => {
          console.log(`Remote user ${user.uid} unpublished ${mediaType}`);
        });
        
        setUiState();
        console.log('Video call started successfully!');
        
      } catch (error) {
        console.error(`Error: ${error.message}`);
        alert(`Error: ${error.message}`);
      }
    }

    async function leave() {
      if (!joined) return;
      if (localAudioTrack) { localAudioTrack.stop(); localAudioTrack.close(); localAudioTrack = null; }
      if (localVideoTrack) { localVideoTrack.stop(); localVideoTrack.close(); localVideoTrack = null; }
      await client.leave();
      q('local-player').innerHTML = '';
      q('remote-player').innerHTML = '';
      joined = false;
      setUiState();
    }

    async function toggleAudio() {
      if (!localAudioTrack) return;
      if (localAudioTrack.isPlaying) {
        await localAudioTrack.setEnabled(false);
        localAudioTrack.isPlaying = false;
        this.innerText = 'Unmute Audio';
      } else {
        await localAudioTrack.setEnabled(true);
        localAudioTrack.isPlaying = true;
        this.innerText = 'Mute Audio';
      }
    }

    async function toggleVideo() {
      if (!localVideoTrack) return;
      const enabled = localVideoTrack.enabled !== false;
      await localVideoTrack.setEnabled(!enabled);
      this.innerText = enabled ? 'Unmute Video' : 'Mute Video';
    }

    q('join').addEventListener('click', () => join().catch(err => alert(err.message || err)));
    q('leave').addEventListener('click', () => leave().catch(console.error));
    q('toggle-audio').addEventListener('click', function() { toggleAudio.call(this); });
    q('toggle-video').addEventListener('click', function() { toggleVideo.call(this); });

    // Initialize UI with hard-coded defaults
    window.addEventListener('DOMContentLoaded', () => {
      q('appId').value = DEFAULTS.appId;
      q('channel').value = DEFAULTS.channel;
      q('token').value = ''; // Clear token field - will be generated automatically
      q('uid').value = DEFAULTS.uid;
      q('role').value = DEFAULTS.role === 'host' ? 'host' : 'audience';
      q('audio').value = DEFAULTS.audio ? 'on' : 'off';
      q('video').value = DEFAULTS.video ? 'on' : 'off';

      // Keep all inputs editable for flexibility
      q('appId').disabled = false;
      q('channel').disabled = false;
      q('token').disabled = false; // Allow manual token entry if needed
      q('uid').disabled = false;
      q('role').disabled = false;
      q('audio').disabled = false;
      q('video').disabled = false;

      // Focus on channel input since token is auto-generated
      q('channel').focus();
      q('channel').select();

      setUiState();
    });
  </script>
</body>
</html>


